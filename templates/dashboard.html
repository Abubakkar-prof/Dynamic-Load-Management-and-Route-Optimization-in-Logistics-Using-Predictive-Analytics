{% extends "base.html" %}

{% block title %}Dashboard - Logistics AI{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        padding: 1.5rem;
        background: var(--bg-surface);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--border-default);
        border-radius: 20px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: var(--brand-primary);
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-bottom: 1.25rem;
    }

    .stat-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-body);
        margin-bottom: 0.25rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-heading);
        margin: 0;
        letter-spacing: -0.5px;
    }

    .stat-change {
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.75rem;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .map-container-pro {
        border-radius: 24px;
        overflow: hidden;
        border: 1px solid var(--border-default);
        background: var(--bg-surface);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        margin-bottom: 2.5rem;
    }

    #map {
        height: 500px;
        filter: grayscale(1) invert(0.9) contrast(1.2);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 2.5rem;
    }

    .chart-container-pro {
        padding: 1.5rem;
        background: var(--bg-surface);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--border-default);
        border-radius: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="section-header">
    <div>
        <h2 class="fw-bold text-heading mb-1" style="letter-spacing: -1px;">Operational Intelligence</h2>
        <p class="text-body mb-0 small">Real-time fleet synchronization and predictive demand analysis.</p>
    </div>
    <div class="d-flex gap-3">
        <a href="#" class="btn btn-primary py-2 px-4 shadow-sm">
            <i class="fas fa-plus me-2"></i>New Dispatch
        </a>
    </div>
</div>

<!-- KPI Grid -->
<div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-label">Projected Demand</div>
            <h3 class="stat-value" id="forecast-vol">-</h3>
            <div class="stat-change text-success">
                <i class="fas fa-arrow-up"></i><span>12.5%</span>
                <span class="text-body opacity-50 ms-1 fw-normal">vs last week</span>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-success bg-opacity-10 text-success">
                <i class="fas fa-truck-container"></i>
            </div>
            <div class="stat-label">Active Assets</div>
            <h3 class="stat-value" id="active-fleet">-</h3>
            <div class="stat-change text-success">
                <i class="fas fa-signal"></i><span>Full Coverage</span>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-info bg-opacity-10 text-info">
                <i class="fas fa-weight-scale"></i>
            </div>
            <div class="stat-label">Fleet Capacity</div>
            <h3 class="stat-value" id="fleet-cap">-</h3>
            <div class="stat-change text-info">
                <i class="fas fa-microchip"></i><span>Optimized</span>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                <i class="fas fa-clock-rotate-left"></i>
            </div>
            <div class="stat-label">Pending Queue</div>
            <h3 class="stat-value" id="pending-orders">-</h3>
            <div class="stat-change text-warning">
                <i class="fas fa-triangle-exclamation"></i><span>Priority Check</span>
            </div>
        </div>
    </div>

    <!-- ROI & Sustainability Grid -->
    <div class="row g-4 mb-5">
        <div class="col-xl-4 col-md-6">
            <div class="stat-card border-primary border-opacity-25"
                style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(5, 11, 24, 0.8) 100%);">
                <div class="stat-icon bg-primary text-white shadow-sm">
                    <i class="fas fa-hand-holding-dollar"></i>
                </div>
                <div class="stat-label">Financial ROI (Est.)</div>
                <h3 class="stat-value text-primary" id="pkr-saved">₨ 0.00</h3>
                <div class="stat-change text-primary">
                    <i class="fas fa-check-double"></i><span>Direct Cost Saving</span>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6">
            <div class="stat-card border-success border-opacity-25"
                style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 11, 24, 0.8) 100%);">
                <div class="stat-icon bg-success text-white shadow-sm">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="stat-label">Carbon Offset (CO2)</div>
                <h3 class="stat-value text-success" id="co2-saved">0.00 kg</h3>
                <div class="stat-change text-success">
                    <i class="fas fa-earth-asia"></i><span>Green Logistics Active</span>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-12">
            <div class="stat-card">
                <div class="stat-icon bg-info bg-opacity-10 text-info">
                    <i class="fas fa-route"></i>
                </div>
                <div class="stat-label">Total Distance Optimized</div>
                <h3 class="stat-value" id="km-optimized">0.00 km</h3>
                <div class="stat-change text-info">
                    <i class="fas fa-bolt"></i><span>Pathfinding Efficiency</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Operations Map -->
    <div class="map-container-pro">
        <div
            class="px-4 py-3 border-bottom border-white border-opacity-5 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0 text-heading small">Live Telemetry Map</h6>
            <div class="badge bg-success bg-opacity-10 text-success border-0 rounded-pill x-small px-3">
                <i class="fas fa-circle me-1" style="font-size: 5px;"></i>System Online
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- Secondary Analytics -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="chart-container-pro h-100">
                <h6 class="fw-bold text-heading small mb-4">Demand Projection Analysis</h6>
                <canvas id="demandChart" style="max-height: 280px;"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-container-pro h-100">
                <h6 class="fw-bold text-heading small mb-4">Resource Saturation</h6>
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="x-small text-body">Fleet Utilization</span>
                        <span class="x-small text-heading fw-bold" id="fleet-util">-</span>
                    </div>
                    <div class="progress" style="height: 6px; background: rgba(255,255,255,0.05);">
                        <div class="progress-bar bg-primary" id="util-progress"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="x-small text-body">Daily Throughput</span>
                        <span class="x-small text-heading fw-bold" id="today-orders">-</span>
                    </div>
                    <div class="progress" style="height: 6px; background: rgba(255,255,255,0.05);">
                        <div class="progress-bar bg-success" id="today-progress" style="width: 70%;"></div>
                    </div>
                </div>
                <div class="pt-4 border-top border-white border-opacity-5 mt-auto">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <div class="bg-success rounded-circle" style="width: 6px; height: 6px;"></div>
                        <span class="x-small">AI Engine Active</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-primary rounded-circle" style="width: 6px; height: 6px;"></div>
                        <span class="x-small">Latency: 0.4ms</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Map
    const map = L.map('map').setView([31.5204, 74.3587], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    // Custom Vehicle Icon
    const vehicleIcon = L.divIcon({
        className: 'custom-div-icon',
        html: "<div style='background-color:#4361ee; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px #4361ee;'></div>",
        iconSize: [12, 12],
        iconAnchor: [6, 6]
    });

    const markers = {};

    // SocketIO Connection
    const socket = io();
    socket.on('connect', () => console.log('Connected to Live Telemetry'));

    const routeLines = {};
    const alertedStops = new Set();

    socket.on('location_update', (data) => {
        const { vehicle_id, lat, lng, status, route_id, proximity_alert, distance_to_stop, next_stop_id, route_steps } = data;

        // 1. Draw/Update Planned Path
        if (route_steps && route_steps.length > 0) {
            // Convert steps to LatLng array (adding current position as start)
            const pathPoints = [[lat, lng]]; // Start from current live position
            route_steps.forEach(step => pathPoints.push([step.latitude, step.longitude]));

            if (routeLines[vehicle_id]) {
                routeLines[vehicle_id].setLatLngs(pathPoints);
            } else {
                routeLines[vehicle_id] = L.polyline(pathPoints, {
                    color: '#00d4ff', // Brighter Neon Blue
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 10',
                    lineJoin: 'round'
                }).addTo(map);
            }
        }

        // 2. Proximity Alert Trigger
        if (proximity_alert && !alertedStops.has(next_stop_id)) {
            showToast('Arrival Alert', `Asset ${vehicle_id} is ${distance_to_stop}km away from stop ${next_stop_id}!`, 'info');
            alertedStops.add(next_stop_id);
        }

        const popupContent = `
            <strong>Vehicle: ${vehicle_id}</strong><br>
            Status: ${status}<br>
            ${distance_to_stop ? `<span class='text-body x-small'>Next Stop: ${distance_to_stop}km</span><br>` : ''}
            ${route_id ? `
            <div class="mt-2 border-top border-white border-opacity-10 pt-2">
                <span class='text-primary x-small fw-bold'>Route: ${route_id}</span><br>
                <div class="d-flex gap-1 mt-1">
                    <a href="/optimization/routes" class="btn btn-primary btn-sm py-1 px-2 text-white x-small" style="font-size:9px;">
                        <i class="fas fa-eye me-1"></i>View
                    </a>
                    <button onclick="reoptimizeRoute('${route_id}')" class="btn btn-warning btn-sm py-1 px-2 text-dark x-small fw-bold" style="font-size:9px;">
                        <i class="fas fa-arrows-rotate me-1"></i>Recalculate
                    </button>
                </div>
            </div>` : ''}
        `;

        if (markers[vehicle_id]) {
            markers[vehicle_id].setLatLng([lat, lng]);
            markers[vehicle_id].getPopup().setContent(popupContent);
        } else {
            markers[vehicle_id] = L.marker([lat, lng], { icon: vehicleIcon })
                .addTo(map)
                .bindPopup(popupContent);
        }
    });

    // Load Stats
    fetch('/api/stats')
        .then(res => res.json())
        .then(data => {
            document.getElementById('forecast-vol').textContent = data.forecast_volume || '0';
            document.getElementById('active-fleet').textContent = data.active_vehicles || '0';
            document.getElementById('fleet-cap').textContent = (data.fleet_capacity_kg || '0') + ' kg';
            document.getElementById('pending-orders').textContent = data.pending_orders || '0';
            document.getElementById('today-orders').textContent = data.total_orders_today || '0';

            // Populate ROI & Sustainability
            document.getElementById('pkr-saved').textContent = '₨ ' + (data.pkr_saved || 0).toLocaleString();
            document.getElementById('co2-saved').textContent = (data.co2_saved || 0).toLocaleString() + ' kg';
            document.getElementById('km-optimized').textContent = (data.total_km_optimized || 0).toLocaleString() + ' km';

            // Calculate utilization
            const util = data.total_vehicles > 0 ? Math.round((data.active_vehicles / data.total_vehicles) * 100) : 0;
            document.getElementById('fleet-util').textContent = util + '%';
            document.getElementById('util-progress').style.width = util + '%';
        })
        .catch(err => console.error('Error loading stats:', err));

    // Load Chart
    fetch('/api/forecast_chart')
        .then(res => res.json())
        .then(data => {
            const ctx = document.getElementById('demandChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Orders',
                        data: data.values || [],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        })
        .catch(err => console.error('Error loading chart:', err));
    function reoptimizeRoute(routeId) {
        showToast('Processing', 'Recalculating optimal path from current GPS coordinates...', 'warning');
        fetch('/optimization/api/reoptimize-route', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ route_id: routeId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Success', data.message, 'success');
                } else {
                    showToast('Error', data.error, 'danger');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('System Error', 'Failed to reach optimization server', 'danger');
            });
    }
</script>
{% endblock %}