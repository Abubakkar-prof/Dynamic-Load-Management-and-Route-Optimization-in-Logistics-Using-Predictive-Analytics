{% extends "base.html" %}

{% block title %}Delivery Time Prediction{% endblock %}

{% block content %}
<div class="section-header">
  <div>
    <h2 class="fw-bold text-heading mb-1" style="letter-spacing: -1px;">Predictive Logistics Engine</h2>
    <p class="text-body mb-0 small">Random Forest regression models for hyperscale delivery time estimation.</p>
  </div>
  <div class="d-flex gap-3">
    <button type="button" class="btn btn-secondary py-2 px-4 shadow-sm border-white border-opacity-10"
      id="trainModelBtn">
      <i class="fas fa-brain me-2 text-primary"></i>Optimization Retraining
    </button>
  </div>
</div>

<div class="row g-4">
  <!-- Input Form -->
  <div class="col-xl-5">
    <div class="card h-100">
      <div class="d-flex align-items-center mb-4">
        <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3">
          <i class="fas fa-sliders text-primary"></i>
        </div>
        <h6 class="fw-bold text-heading mb-0 small">Simulation Parameters</h6>
      </div>

      <form id="predictionForm">
        <div class="row g-3 mb-4">
          <div class="col-6">
            <label class="x-small text-body opacity-50 fw-bold text-uppercase mb-2 d-block">Logistics Distance
              (km)</label>
            <input type="number" class="form-control" id="distance" value="25" step="0.1" required>
          </div>
          <div class="col-6">
            <label class="x-small text-body opacity-50 fw-bold text-uppercase mb-2 d-block">Payload Mass (kg)</label>
            <input type="number" class="form-control" id="weight" value="5" step="0.1" required>
          </div>
          <div class="col-6">
            <label class="x-small text-body opacity-50 fw-bold text-uppercase mb-2 d-block">Priority Class</label>
            <select class="form-select" id="priority">
              <option value="1">Standard (Low)</option>
              <option value="2">Business (Med)</option>
              <option value="3">Priority (High)</option>
              <option value="4" selected>Critical (Urgent)</option>
            </select>
          </div>
          <div class="col-6">
            <label class="x-small text-body opacity-50 fw-bold text-uppercase mb-2 d-block">Regional Zone</label>
            <select class="form-select" id="region">
              <option value="North">North Hub</option>
              <option value="South">South Sector</option>
              <option value="East">East Corridor</option>
              <option value="West">West Network</option>
              <option value="Central" selected>Central Command</option>
            </select>
          </div>
          <div class="col-6">
            <label class="x-small text-body opacity-50 fw-bold text-uppercase mb-2 d-block">Asset Class</label>
            <select class="form-select" id="vehicleType">
              <option value="Van" selected>Express Van</option>
              <option value="Truck">Heavy Duty Truck</option>
            </select>
          </div>
          <div class="col-6">
            <label class="x-small text-body opacity-50 fw-bold text-uppercase mb-2 d-block">Temporal Window
              (Hour)</label>
            <input type="number" class="form-control" id="hourOfDay" min="0" max="23" value="14">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 py-3 rounded-4 shadow-lg">
          <i class="fas fa-bolt-lightning me-2"></i>Execute Prediction Model
        </button>
      </form>
    </div>
  </div>

  <!-- Results/Analysis -->
  <div class="col-xl-7">
    <div class="card h-100 p-0 overflow-hidden">
      <div
        class="px-4 py-3 border-bottom border-white border-opacity-5 bg-dark bg-opacity-25 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-heading small"><i class="fas fa-chart-line me-2 text-success"></i>Model Inference
          Output</h6>
        <div class="badge bg-info bg-opacity-10 text-info border-0 rounded-pill x-small px-3">Steady State</div>
      </div>

      <div class="p-5 flex-grow-1 d-flex flex-column justify-content-center align-items-center" id="predictionResult">
        <div class="bg-dark bg-opacity-25 rounded-circle d-inline-flex p-4 mb-4 border border-white border-opacity-5">
          <i class="fas fa-hourglass-start fa-3x text-body opacity-25"></i>
        </div>
        <h5 class="text-heading fw-bold">System Idle</h5>
        <p class="text-body small text-center mb-0" style="max-width: 300px;">Configure simulation parameters on the
          left to initialize the inference sequence.</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-2">
  <div class="col-12">
    <div class="card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h6 class="fw-bold text-heading small mb-0"><i class="fas fa-clock-rotate-left me-2 text-warning"></i>Historical
          Inference Samples</h6>
        <button id="refreshSamples" class="btn btn-secondary btn-sm px-3 x-small">
          <i class="fas fa-sync-alt me-1"></i>Sync
        </button>
      </div>

      <div class="table-responsive">
        <table class="table mb-0" id="samplesTable">
          <thead>
            <tr>
              <th>Inference ID</th>
              <th>Distance</th>
              <th>Payload</th>
              <th>Zone</th>
              <th>Priority</th>
              <th>ETA Estimate</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" class="text-center py-5 opacity-50 x-small">
                <i class="fas fa-spinner fa-spin me-2"></i>Synchronizing historical data stream...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Handle form submission
    document.getElementById('predictionForm').addEventListener('submit', function (e) {
      e.preventDefault();

      // Get form values
      const data = {
        distance_km: parseFloat(document.getElementById('distance').value),
        weight_kg: parseFloat(document.getElementById('weight').value),
        volume_m3: parseFloat(document.getElementById('volume') ? document.getElementById('volume').value : 0),
        priority: parseInt(document.getElementById('priority').value),
        region: document.getElementById('region').value,
        vehicle_type: document.getElementById('vehicleType').value,
        hour_of_day: parseInt(document.getElementById('hourOfDay').value),
        day_of_week: new Date().getDay()
      };

      // Show loading state
      document.getElementById('predictionResult').innerHTML = `
        <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
        <p class="text-muted">Calculating delivery time...</p>
      `;

      // Send prediction request
      fetch('/api/prediction/delivery_time', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            document.getElementById('predictionResult').innerHTML = `
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <p class="text-danger">${result.error}</p>
          `;
          } else {
            const confidenceClass = result.confidence === 'high' ? 'success' : 'warning';
            const confidenceText = result.confidence === 'high' ? 'High Confidence' : 'Medium Confidence';

            document.getElementById('predictionResult').innerHTML = `
            <div class="text-center">
              <i class="fas fa-clock fa-3x text-primary mb-3"></i>
              <h2 class="display-4 fw-bold text-primary">${result.predicted_delivery_time_formatted}</h2>
              <p class="lead">Estimated Delivery Time</p>
              <span class="badge bg-${confidenceClass}">${confidenceText}</span>
              <p class="mt-3">
                <small class="text-muted">
                  Based on distance: ${data.distance_km}km, weight: ${data.weight_kg}kg
                </small>
              </p>
            </div>
          `;
          }
        })
        .catch(error => {
          document.getElementById('predictionResult').innerHTML = `
          <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
          <p class="text-danger">Failed to get prediction: ${error.message}</p>
        `;
        });
    });

    // Handle model training
    document.getElementById('trainModelBtn').addEventListener('click', function () {
      if (!confirm('Are you sure you want to retrain the delivery time prediction model? This may take a few minutes.')) {
        return;
      }

      // Show loading state
      const btn = this;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Training...';
      btn.disabled = true;

      // Send training request
      fetch('/api/prediction/train_delivery_model', {
        method: 'POST'
      })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            alert('Error: ' + result.error);
          } else {
            alert('Success: ' + result.message);
            // Refresh samples
            loadSamplePredictions();
          }
        })
        .catch(error => {
          alert('Failed to train model: ' + error.message);
        })
        .finally(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        });
    });

    // Handle sample refresh
    document.getElementById('refreshSamples').addEventListener('click', loadSamplePredictions);

    // Load sample predictions on page load
    loadSamplePredictions();

    function loadSamplePredictions() {
      // Show loading state
      document.querySelector('#samplesTable tbody').innerHTML = `
        <tr>
          <td colspan="6" class="text-center">
            <i class="fas fa-spinner fa-spin me-2"></i>Loading sample predictions...
          </td>
        </tr>
      `;

      // Fetch sample predictions
      fetch('/api/prediction/delivery_time/sample')
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            document.querySelector('#samplesTable tbody').innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${result.error}
              </td>
            </tr>
          `;
          } else {
            const tbody = document.querySelector('#samplesTable tbody');
            tbody.innerHTML = '';

            result.predictions.forEach(prediction => {
              const row = document.createElement('tr');
              row.innerHTML = `
              <td>${prediction.order_id}</td>
              <td>${prediction.distance_km}</td>
              <td>${prediction.weight_kg}</td>
              <td>${prediction.region}</td>
              <td>
                <span class="badge bg-${getPriorityClass(prediction.priority)}">
                  ${getPriorityText(prediction.priority)}
                </span>
              </td>
              <td>
                <strong>${Math.floor(prediction.predicted_delivery_time_min / 60)}h ${Math.round(prediction.predicted_delivery_time_min % 60)}m</strong>
              </td>
            `;
              tbody.appendChild(row);
            });
          }
        })
        .catch(error => {
          document.querySelector('#samplesTable tbody').innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>Failed to load sample predictions: ${error.message}
            </td>
          </tr>
        `;
        });
    }

    function getPriorityClass(priority) {
      switch (priority) {
        case 1: return 'secondary';
        case 2: return 'info';
        case 3: return 'warning';
        case 4: return 'danger';
        default: return 'secondary';
      }
    }

    function getPriorityText(priority) {
      switch (priority) {
        case 1: return 'Low';
        case 2: return 'Medium';
        case 3: return 'High';
        case 4: return 'Urgent';
        default: return 'Unknown';
      }
    }
  });
</script>
{% endblock %}