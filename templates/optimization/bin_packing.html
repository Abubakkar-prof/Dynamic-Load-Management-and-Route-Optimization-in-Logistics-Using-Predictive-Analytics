{% extends "base.html" %}

{% block title %}Load Optimizer - Logistics AI{% endblock %}

{% block content %}
<div class="section-header">
    <div>
        <h2 class="fw-bold text-heading mb-1" style="letter-spacing: -1px;">3D Load Optimizer</h2>
        <p class="text-body mb-0 small">Optimize vehicle loading using 3D Bin Packing algorithms.</p>
    </div>
    <div class="d-flex gap-3">
        <button id="run-optimization-btn" class="btn btn-primary py-2 px-4 shadow-sm">
            <i class="fas fa-play me-2"></i>Run Optimization
        </button>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-12">
        <div class="card p-4">
            <h6 class="text-uppercase text-body x-small fw-bold mb-4">Optimization Results</h6>
            <div id="results-container" class="text-center py-5">
                <div class="text-body opacity-50">
                    <i class="fas fa-cubes fa-3x mb-3"></i>
                    <p>Click "Run Optimization" to start the Packing Algorithm.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const csrfToken = "{{ csrf_token() }}";
    document.getElementById('run-optimization-btn').addEventListener('click', function () {
        const btn = this;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i>Running...';
        btn.disabled = true;

        const payload = {
            fleet: [
                { vehicle_id: "TRK-001", capacity_kg: 5000, width: 2.5, height: 2.5, depth: 6.0 },
                { vehicle_id: "VAN-001", capacity_kg: 1500, width: 1.8, height: 1.5, depth: 3.0 }
            ],
            orders: Array.from({ length: 20 }, (_, i) => ({
                order_id: `PKG-${1000 + i}`,
                weight_kg: Math.random() * 50 + 10,
                package_width: 0.5,
                package_height: 0.5,
                package_depth: 0.5
            }))
        };

        fetch('/api/bin_packing/optimize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('results-container');
                if (data.error) {
                    container.innerHTML = `<div class="text-danger">${data.error}</div>`;
                } else {
                    let html = `<div class="row text-start">`;
                    data.results.packing_results.forEach(res => {
                        const bin = res.bin;
                        const color = bin.weight_utilization > 90 ? 'danger' : (bin.weight_utilization > 50 ? 'success' : 'warning');

                        html += `
                    <div class="col-md-6 mb-4">
                        <div class="border border-secondary border-opacity-25 rounded-3 p-3 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold text-heading mb-0"><i class="fas fa-truck me-2"></i>${bin.bin_id}</h6>
                                <span class="badge bg-${color} bg-opacity-10 text-${color}">${bin.weight_utilization.toFixed(1)}% Full</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-${color}" role="progressbar" style="width: ${bin.weight_utilization}%"></div>
                            </div>
                            <div class="row g-2 x-small text-body">
                                <div class="col-6">Packed Items: <span class="text-heading fw-bold">${bin.item_count}</span></div>
                                <div class="col-6">Weight: <span class="text-heading fw-bold">${bin.current_weight.toFixed(1)}kg</span></div>
                            </div>
                        </div>
                    </div>`;
                    });
                    html += `</div>`;

                    const stats = data.results.statistics;
                    html += `
                <div class="mt-4 p-3 bg-primary bg-opacity-10 rounded-3">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="text-body x-small">Packing Efficiency</div>
                            <div class="text-heading fw-bold h4">${stats.packing_efficiency.toFixed(1)}%</div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-body x-small">Total Items</div>
                            <div class="text-heading fw-bold h4">${stats.total_items}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-body x-small">Packed Items</div>
                            <div class="text-heading fw-bold h4">${stats.packed_items}</div>
                        </div>
                    </div>
                </div>`;

                    container.innerHTML = html;
                }
                btn.innerHTML = '<i class="fas fa-play me-2"></i>Run Optimization';
                btn.disabled = false;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('results-container').innerHTML = '<div class="text-danger">Error running optimization</div>';
                btn.innerHTML = '<i class="fas fa-play me-2"></i>Run Optimization';
                btn.disabled = false;
            });
    });
</script>
{% endblock %}