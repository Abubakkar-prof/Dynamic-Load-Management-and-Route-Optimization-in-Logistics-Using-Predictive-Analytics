{% extends "base.html" %}

{% block title %}Routes - Logistics AI{% endblock %}

{% block content %}
<div class="section-header">
    <div>
        <div class="x-small text-body opacity-50 fw-bold text-uppercase mb-1" style="letter-spacing: 1px;">Route
            Optimization</div>
        <h2 class="fw-bold text-heading mb-1" style="letter-spacing: -1px;">Tactical Route Intelligence</h2>
        <p class="text-body mb-0 small">Automated solver outputs and hardware assignment clusters.</p>
    </div>
    <div class="d-flex gap-3">
        <button class="btn btn-primary py-2 px-4 shadow-sm" onclick="runOptimization()">
            <i class="fas fa-microchip me-2"></i>Initiate Neural Solver
        </button>
    </div>
</div>

<div class="card p-0 overflow-hidden">
    <div
        class="px-4 py-3 border-bottom border-white border-opacity-5 bg-dark bg-opacity-25 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-heading small"><i class="fas fa-route me-2 text-primary"></i>Active Manifests</h6>
        <div class="badge bg-primary bg-opacity-10 text-primary border-0 px-3 py-1 rounded-pill x-small fw-bold">{{
            routes|length }} OPTIMIZED PATHS</div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-dark bg-opacity-25">
                <tr class="x-small text-uppercase fw-bold text-body opacity-50" style="letter-spacing: 1px;">
                    <th class="ps-4 py-3">Route ID</th>
                    <th class="py-3">Hardware Assign.</th>
                    <th class="py-3">Operator</th>
                    <th class="py-3 text-center">Distance</th>
                    <th class="py-3 text-center">Payload</th>
                    <th class="py-3" style="width: 15%;">Utilization</th>
                    <th class="py-3 text-center">Status</th>
                    <th class="py-3">Timestamp</th>
                    <th class="pe-4 py-3 text-end">Interface</th>
                </tr>
            </thead>
            <tbody>
                {% for route in routes %}
                <tr class="border-white border-opacity-5">
                    <td class="ps-4 py-3">
                        <div class="fw-bold text-heading small">{{ route.route_id }}</div>
                    </td>
                    <td class="py-3">
                        {% if route.vehicle %}
                        <span class="badge bg-info bg-opacity-10 text-info border-0 px-2 py-1 x-small fw-bold">{{
                            route.vehicle.vehicle_id }}</span>
                        {% else %}
                        <span class="opacity-25 x-small fw-bold">UNASSIGNED</span>
                        {% endif %}
                    </td>
                    <td class="py-3">
                        <div class="text-heading x-small fw-bold">{{ route.driver.user.full_name if route.driver and
                            route.driver.user else 'AUTO-PILOT' }}</div>
                    </td>
                    <td class="py-3 text-center">
                        <div class="text-body small fw-bold">{{ "%.2f"|format(route.total_distance_km or 0) }} km</div>
                    </td>
                    <td class="py-3 text-center">
                        <div class="text-body small fw-bold">{{ route.total_load_kg }} kg</div>
                    </td>
                    <td class="py-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1"
                                style="height: 6px; background-color: rgba(255,255,255,0.05);">
                                {% set util_width = (route.utilization_pct or 0)|string + '%' %}
                                <div class="progress-bar bg-primary" role="progressbar" style="width: var(--u-width);"
                                    data-width="{{ util_width }}"
                                    onload="this.style.setProperty('--u-width', this.dataset.width)"></div>
                                <script>
                                    document.querySelectorAll('.progress-bar').forEach(el => {
                                        if (el.dataset.width) el.style.width = el.dataset.width;
                                    });
                                </script>
                            </div>
                            <span class="x-small fw-bold text-heading">{{ "%.1f"|format(route.utilization_pct or 0)
                                }}%</span>
                        </div>
                    </td>
                    <td class="py-3 text-center">
                        {% if route.status == 'Active' %}
                        <span
                            class="badge bg-success bg-opacity-10 text-success border-0 px-2 py-1 x-small fw-bold">ACTIVE</span>
                        {% elif route.status == 'Planned' %}
                        <span
                            class="badge bg-warning bg-opacity-10 text-warning border-0 px-2 py-1 x-small fw-bold">PLANNED</span>
                        {% elif route.status == 'Completed' %}
                        <span
                            class="badge bg-primary bg-opacity-10 text-primary border-0 px-2 py-1 x-small fw-bold">ARCHIVED</span>
                        {% else %}
                        <span
                            class="badge bg-secondary bg-opacity-10 text-secondary border-0 px-2 py-1 x-small fw-bold">{{
                            route.status|upper }}</span>
                        {% endif %}
                    </td>
                    <td class="py-3">
                        <div class="x-small text-body opacity-50 fw-bold">{{ route.date.strftime('%Y-%m-%d') if
                            route.date else 'TBD' }}</div>
                    </td>
                    <td class="pe-4 py-3 text-end">
                        <a href="{{ url_for('optimization.view_route', route_id=route.id) }}"
                            class="btn btn-secondary btn-sm rounded-3 px-3 py-2 border-white border-opacity-10">
                            <i class="fas fa-magnifying-glass-location me-2 text-primary"></i>Inspect
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <div class="opacity-25 mb-3">
                            <i class="fas fa-route fa-3x"></i>
                        </div>
                        <h6 class="text-heading fw-bold">No optimized routes found</h6>
                        <p class="text-body x-small mb-0">Run the neural solver to generate hardware assignments.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function runOptimization() {
        // Custom enterprise alert
        if (!confirm('Execute multi-dimensional routing solver? Active manifests will be recalibrated.')) return;

        const btn = event.currentTarget || event.target;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calibrating Path...';
        btn.disabled = true;

        fetch('/optimization/api/optimize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ save_routes: true })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(`Solver Exception: ${data.error || 'General Optimization Fault'}`);
                }
            })
            .catch(err => {
                alert('Hardware Error: ' + err);
            })
            .finally(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            });
    }
</script>
{% endblock %}