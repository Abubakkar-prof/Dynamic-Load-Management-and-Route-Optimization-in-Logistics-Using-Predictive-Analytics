{% extends "base.html" %}

{% block title %}Global Orders - Logistics AI{% endblock %}

{% block extra_css %}
<style>
    .search-filter-bar {
        background: var(--bg-surface);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--border-default);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .search-input {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 0.75rem 1rem 0.75rem 3rem;
        color: var(--text-heading);
        width: 100%;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-body);
    }

    .filter-select {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        color: var(--text-heading);
    }

    .table-modern {
        background: var(--bg-surface);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--border-default);
        border-radius: 20px;
        overflow: hidden;
    }

    .table-modern thead th {
        background: rgba(59, 130, 246, 0.05);
        border-bottom: 2px solid rgba(59, 130, 246, 0.2);
        padding: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        cursor: pointer;
        user-select: none;
    }

    .table-modern thead th:hover {
        background: rgba(59, 130, 246, 0.1);
    }

    .table-modern tbody tr {
        border-bottom: 1px solid var(--border-default);
        transition: all 0.2s;
    }

    .table-modern tbody tr:hover {
        background: rgba(59, 130, 246, 0.03);
        transform: scale(1.01);
    }

    .table-modern tbody td {
        padding: 1.25rem 1rem;
        vertical-align: middle;
    }

    .sort-icon {
        margin-left: 0.5rem;
        opacity: 0.3;
        transition: opacity 0.2s;
    }

    .sort-icon.active {
        opacity: 1;
        color: var(--brand-primary);
    }

    .pagination-modern {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: center;
        margin-top: 2rem;
    }

    .page-btn {
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        color: var(--text-body);
        cursor: pointer;
        transition: all 0.2s;
    }

    .page-btn:hover {
        border-color: var(--brand-primary);
        color: var(--brand-primary);
    }

    .page-btn.active {
        background: var(--brand-primary);
        border-color: var(--brand-primary);
        color: white;
    }

    .skeleton-row {
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .order-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-default);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
    }

    .order-card:hover {
        border-color: var(--brand-primary);
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="section-header">
    <div>
        <h2 class="fw-bold text-heading mb-1" style="letter-spacing: -1px;">Global Dispatch Orders</h2>
        <p class="text-body mb-0 small">Manage and track all logistics orders across the network.</p>
    </div>
    <div class="d-flex gap-3">
        <button class="btn btn-secondary py-2 px-4 shadow-sm" onclick="exportOrders()">
            <i class="fas fa-download me-2"></i>Export CSV
        </button>
        <a href="{{ url_for('orders.create_order') }}" class="btn btn-primary py-2 px-4 shadow-sm">
            <i class="fas fa-plus me-2"></i>Create Order
        </a>
    </div>
</div>

<!-- Search & Filter Bar -->
<div class="search-filter-bar">
    <div class="row g-3">
        <div class="col-md-6">
            <div class="position-relative">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input"
                    placeholder="Search orders by ID, customer, or address...">
            </div>
        </div>
        <div class="col-md-2">
            <select id="statusFilter" class="filter-select form-select">
                <option value="">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Assigned">Assigned</option>
                <option value="In Transit">In Transit</option>
                <option value="Delivered">Delivered</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="sortBy" class="filter-select form-select">
                <option value="order_id">Order ID</option>
                <option value="customer_name">Customer</option>
                <option value="weight_kg">Weight</option>
                <option value="status">Status</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="perPage" class="filter-select form-select">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>
    </div>
</div>

<!-- Stats Summary -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card p-3">
            <div class="text-body x-small text-uppercase fw-bold mb-1">Total Orders</div>
            <h3 class="text-heading fw-bold mb-0" id="totalOrders">-</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <div class="text-body x-small text-uppercase fw-bold mb-1">Pending</div>
            <h3 class="text-warning fw-bold mb-0" id="pendingOrders">-</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <div class="text-body x-small text-uppercase fw-bold mb-1">In Transit</div>
            <h3 class="text-primary fw-bold mb-0" id="transitOrders">-</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <div class="text-body x-small text-uppercase fw-bold mb-1">Delivered</div>
            <h3 class="text-success fw-bold mb-0" id="deliveredOrders">-</h3>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="table-modern">
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th onclick="sortTable('order_id')">Order ID <i class="fas fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('customer_name')">Customer <i class="fas fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('delivery_address')">Destination <i class="fas fa-sort sort-icon"></i></th>
                    <th onclick="sortTable('weight_kg')">Metrics <i class="fas fa-sort sort-icon"></i></th>
                    <th>Time Window</th>
                    <th onclick="sortTable('status')">Status <i class="fas fa-sort sort-icon"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="orders-table-body">
                <tr class="skeleton-row">
                    <td colspan="7" class="text-center py-5 text-body opacity-50">
                        <i class="fas fa-circle-notch fa-spin me-2"></i>Loading Orders...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="pagination-modern" id="pagination"></div>

{% endblock %}

{% block extra_js %}
<script>
    let allOrders = [];
    let filteredOrders = [];
    let currentPage = 1;
    let perPage = 10;
    let sortColumn = 'order_id';
    let sortDirection = 'asc';

    // Fetch orders
    fetch('/api/orders/')
        .then(res => res.json())
        .then(data => {
            allOrders = data;
            filteredOrders = data;
            updateStats();
            renderTable();
        })
        .catch(err => console.error(err));

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        filteredOrders = allOrders.filter(order =>
            order.order_id.toLowerCase().includes(query) ||
            order.customer_name.toLowerCase().includes(query) ||
            order.delivery_address.toLowerCase().includes(query)
        );
        currentPage = 1;
        renderTable();
    });

    // Status filter
    document.getElementById('statusFilter').addEventListener('change', (e) => {
        const status = e.target.value;
        filteredOrders = status ? allOrders.filter(o => o.status === status) : allOrders;
        currentPage = 1;
        renderTable();
    });

    // Per page selector
    document.getElementById('perPage').addEventListener('change', (e) => {
        perPage = parseInt(e.target.value);
        currentPage = 1;
        renderTable();
    });

    // Sort table
    function sortTable(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }

        filteredOrders.sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];

            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        renderTable();
    }

    // Update stats
    function updateStats() {
        document.getElementById('totalOrders').textContent = allOrders.length;
        document.getElementById('pendingOrders').textContent = allOrders.filter(o => o.status === 'Pending').length;
        document.getElementById('transitOrders').textContent = allOrders.filter(o => o.status === 'In Transit').length;
        document.getElementById('deliveredOrders').textContent = allOrders.filter(o => o.status === 'Delivered').length;
    }

    // Render table
    function renderTable() {
        const tbody = document.getElementById('orders-table-body');
        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const pageOrders = filteredOrders.slice(start, end);

        if (pageOrders.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <i class="fas fa-box-open mb-3 d-block" style="font-size: 2rem; opacity: 0.3;"></i>
                    <p class="text-body">No orders found</p>
                </td>
            </tr>
        `;
            return;
        }

        tbody.innerHTML = pageOrders.map(order => {
            const statusColors = {
                'Pending': 'warning',
                'Assigned': 'info',
                'In Transit': 'primary',
                'Delivered': 'success',
                'Cancelled': 'danger'
            };
            const badgeColor = statusColors[order.status] || 'secondary';

            return `
            <tr>
                <td>
                    <div class="bg-primary bg-opacity-10 text-primary rounded px-2 py-1 x-small fw-bold d-inline-block">
                        ${order.order_id}
                    </div>
                </td>
                <td>
                    <div class="fw-semibold text-heading">${order.customer_name}</div>
                </td>
                <td style="max-width: 200px;">
                    <div class="text-truncate" title="${order.delivery_address}">${order.delivery_address}</div>
                </td>
                <td>
                    <div class="x-small">
                        <span class="text-body">Wt:</span> <span class="text-heading fw-bold">${order.weight_kg}kg</span>
                        <span class="mx-1 text-body opacity-25">|</span>
                        <span class="text-body">Vol:</span> <span class="text-heading fw-bold">${order.volume_m3}m³</span>
                    </div>
                </td>
                <td>
                    <div class="badge bg-secondary bg-opacity-10 text-body border border-secondary border-opacity-25 fw-normal">
                        ${order.time_window_start}:00 - ${order.time_window_end}:00
                    </div>
                </td>
                <td>
                    <span class="badge bg-${badgeColor} bg-opacity-10 text-${badgeColor} border border-${badgeColor} border-opacity-25">
                        ${order.status}
                    </span>
                </td>
                <td>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-icon btn-secondary" title="View Details">
                            <i class="fas fa-eye x-small"></i>
                        </button>
                        <button class="btn btn-sm btn-icon btn-secondary" title="Edit">
                            <i class="fas fa-pen x-small"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        }).join('');

        renderPagination();
    }

    // Render pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredOrders.length / perPage);
        const pagination = document.getElementById('pagination');

        let html = `
        <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
    `;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<span class="text-body">...</span>`;
            }
        }

        html += `
        <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;

        pagination.innerHTML = html;
    }

    function changePage(page) {
        const totalPages = Math.ceil(filteredOrders.length / perPage);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderTable();
    }

    function exportOrders() {
        // Simple CSV export
        const csv = [
            ['Order ID', 'Customer', 'Address', 'Weight (kg)', 'Volume (m³)', 'Status'],
            ...filteredOrders.map(o => [o.order_id, o.customer_name, o.delivery_address, o.weight_kg, o.volume_m3, o.status])
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'orders.csv';
        a.click();
    }
</script>
{% endblock %}