{% extends "base.html" %}

{% block title %}AI Forecasting - Logistics AI{% endblock %}

{% block content %}
<div class="section-header">
    <div>
        <h2 class="fw-bold text-heading mb-1" style="letter-spacing: -1px;">AI Delivery Forecasting</h2>
        <p class="text-body mb-0 small">Predict delivery times using Machine Learning models trained on historical data.
        </p>
    </div>
    <div class="d-flex gap-3">
        <button id="train-btn" class="btn btn-secondary py-2 px-4 shadow-sm">
            <i class="fas fa-brain me-2"></i>Retrain Model
        </button>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card p-4 h-100">
            <h6 class="text-uppercase text-body x-small fw-bold mb-4">Prediction Parameters</h6>
            <form id="prediction-form">
                <input type="hidden" name="csrf_token" value="">
                <div class="mb-3">
                    <label class="form-label text-body x-small">Distance (km)</label>
                    <input type="number" name="distance_km" class="form-control" value="25" required>
                </div>
                <div class="mb-3">
                    <label class="form-label text-body x-small">Weight (kg)</label>
                    <input type="number" name="weight_kg" class="form-control" value="10" required>
                </div>
                <div class="mb-3">
                    <label class="form-label text-body x-small">Volume (mÂ³)</label>
                    <input type="number" name="volume_m3" step="0.1" class="form-control" value="0.5" required>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label text-body x-small">Vehicle</label>
                        <select name="vehicle_type" class="form-select">
                            <option value="Van">Van</option>
                            <option value="Truck">Truck</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-body x-small">Priority</label>
                        <select name="priority" class="form-select">
                            <option value="1">Standard</option>
                            <option value="2">High</option>
                            <option value="3">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-body x-small">Region</label>
                    <select name="region" class="form-select">
                        <option value="Central">Central</option>
                        <option value="North">North</option>
                        <option value="South">South</option>
                        <option value="amount">East</option>
                        <option value="West">West</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-2">
                    <i class="fas fa-calculator me-2"></i>Predict Time
                </button>
            </form>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card p-5 h-100 d-flex flex-column align-items-center justify-content-center text-center"
            id="result-card">
            <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center mb-4"
                style="width: 80px; height: 80px;">
                <i class="fas fa-clock fa-2x"></i>
            </div>
            <h3 class="fw-bold text-heading mb-2">Ready to Forecast</h3>
            <p class="text-body" style="max-width: 400px;">Enter the shipment parameters on the left to generate a
                delivery time estimate using our Random Forest Regression model.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('train-btn').addEventListener('click', function () {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i>Training...';
        btn.disabled = true;

        fetch('/api/prediction/train_delivery_model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            }
        })
            .then(res => res.json())
            .then(data => {
                alert('Model Retrained Successfully (MAE: ' + data.mae.toFixed(2) + ' min)');
                btn.innerHTML = originalText;
                btn.disabled = false;
            })
            .catch(err => {
                alert('Training Failed');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    });

    document.getElementById('prediction-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        // Convert types
        data.distance_km = parseFloat(data.distance_km);
        data.weight_kg = parseFloat(data.weight_kg);
        data.volume_m3 = parseFloat(data.volume_m3);
        data.priority = parseInt(data.priority);

        fetch('/api/prediction/delivery_time', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const resultHtml = `
                <div class="bg-success bg-opacity-10 text-success rounded-circle d-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                    <i class="fas fa-check fa-2x"></i>
                </div>
                <h5 class="text-uppercase text-body x-small fw-bold mb-2">Estimated Delivery Time</h5>
                <h1 class="display-4 fw-bold text-heading mb-2">${data.predicted_delivery_time_formatted}</h1>
                <p class="text-success fw-bold bg-success bg-opacity-10 px-3 py-1 rounded-pill mt-2">
                    <i class="fas fa-shield-alt me-2"></i>${data.confidence.toUpperCase()} CONFIDENCE
                </p>
                <p class="text-body x-small mt-3">Based on ${data.predicted_delivery_time_minutes} minutes raw prediction.</p>
            `;
                document.getElementById('result-card').innerHTML = resultHtml;
            });
    });
</script>
{% endblock %}