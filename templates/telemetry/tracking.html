{% extends "base.html" %}

{% block title %}Live Telemetry - Logistics AI{% endblock %}

{% block content %}
<div class="section-header">
    <div>
        <h2 class="fw-bold text-heading mb-1" style="letter-spacing: -1px;">Live Fleet Telemetry</h2>
        <p class="text-body mb-0 small">Real-time tracking and monitoring of active delivery vehicles.</p>
    </div>
    <div class="d-flex gap-3">
        <button id="refresh-btn" class="btn btn-secondary py-2 px-4 shadow-sm">
            <i class="fas fa-sync me-2"></i>Refresh
        </button>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card p-4">
            <h6 class="text-uppercase text-body x-small fw-bold mb-4">Fleet Map</h6>
            <div id="map" style="height: 500px; border-radius: 12px; overflow: hidden;"></div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card p-4">
            <h6 class="text-uppercase text-body x-small fw-bold mb-4">Active Vehicles</h6>
            <div id="vehicle-list">
                <div class="text-center py-5 text-body opacity-50">
                    <i class="fas fa-circle-notch fa-spin me-2"></i>Loading vehicles...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Leaflet Map
    const map = L.map('map').setView([31.5204, 74.3587], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const markers = {};

    function loadVehicles() {
        fetch('{{ url_for("vehicles.api_vehicles") }}')
            .then(res => res.json())
            .then(data => {
                const listContainer = document.getElementById('vehicle-list');
                listContainer.innerHTML = '';

                if (data.length === 0) {
                    listContainer.innerHTML = '<div class="text-body opacity-50 text-center py-3">No active vehicles</div>';
                    return;
                }

                data.forEach(vehicle => {
                    // Add to list
                    const statusColor = vehicle.status === 'On Route' ? 'success' : 'secondary';
                    listContainer.innerHTML += `
                        <div class="border-bottom border-secondary border-opacity-25 py-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold text-heading">${vehicle.vehicle_id}</span>
                                <span class="badge bg-${statusColor} bg-opacity-10 text-${statusColor} x-small">${vehicle.status}</span>
                            </div>
                            <div class="x-small text-body">
                                Type: ${vehicle.type} | Capacity: ${vehicle.capacity_kg}kg
                            </div>
                        </div>
                    `;

                    // Add to map if has location
                    if (vehicle.current_location_lat && vehicle.current_location_lon) {
                        const lat = parseFloat(vehicle.current_location_lat);
                        const lon = parseFloat(vehicle.current_location_lon);

                        if (markers[vehicle.vehicle_id]) {
                            markers[vehicle.vehicle_id].setLatLng([lat, lon]);
                        } else {
                            const icon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background: #3b82f6; color: white; padding: 8px 12px; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                    <i class="fas fa-truck"></i> ${vehicle.vehicle_id}
                                </div>`,
                                iconSize: [100, 40]
                            });

                            markers[vehicle.vehicle_id] = L.marker([lat, lon], { icon: icon })
                                .addTo(map)
                                .bindPopup(`
                                    <b>${vehicle.vehicle_id}</b><br>
                                    Status: ${vehicle.status}<br>
                                    ${vehicle.active_route ? `
                                    <div class="mt-2 border-top border-secondary border-opacity-10 pt-2">
                                        <span class="text-primary x-small fw-bold">Route: ${vehicle.active_route}</span><br>
                                        <div class="d-flex gap-1 mt-1">
                                            <a href="/optimization/routes" class="btn btn-primary btn-sm py-1 px-2 text-white x-small" style="font-size:9px;">View</a>
                                            <button onclick="reoptimizeRoute('${vehicle.active_route}')" class="btn btn-warning btn-sm py-1 px-2 text-dark x-small fw-bold" style="font-size:9px;">Recalculate</button>
                                        </div>
                                    </div>` : ''}
                                `);
                        }
                    }
                });
            })
            .catch(err => console.error(err));
    }

    // Connect to Socket.io
    const socket = io();
    const routeLines = {};

    socket.on('connect', () => {
        console.log('Real-time Telemetry Connected');
    });

    socket.on('location_update', (data) => {
        const { vehicle_id, lat, lng, status, route_id, distance_to_stop, route_steps } = data;

        // Draw/Update Planned Path
        if (route_steps && route_steps.length > 0) {
            const pathPoints = [[lat, lng]];
            route_steps.forEach(step => pathPoints.push([step.latitude, step.longitude]));

            if (routeLines[vehicle_id]) {
                routeLines[vehicle_id].setLatLngs(pathPoints);
            } else {
                routeLines[vehicle_id] = L.polyline(pathPoints, {
                    color: '#00d4ff', // Brighter Neon Blue
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 10',
                    lineJoin: 'round'
                }).addTo(map);
            }
        }

        // Update Marker
        if (markers[vehicle_id]) {
            markers[vehicle_id].setLatLng([lat, lng]);
            markers[vehicle_id].getPopup().setContent(`
                <b>${vehicle_id}</b><br>
                Status: ${status}<br>
                ${distance_to_stop ? `<span class='text-body x-small'>Next Stop: ${distance_to_stop}km</span><br>` : ''}
                ${route_id ? `
                <div class="mt-2 border-top border-secondary border-opacity-10 pt-2">
                    <span class="text-primary x-small fw-bold">Route: ${route_id}</span><br>
                     <div class="d-flex gap-1 mt-1">
                        <a href="/optimization/routes" class="btn btn-primary btn-sm py-1 px-2 text-white x-small" style="font-size:9px;">View</a>
                        <button onclick="reoptimizeRoute('${route_id}')" class="btn btn-warning btn-sm py-1 px-2 text-dark x-small fw-bold" style="font-size:9px;">Recalculate</button>
                    </div>
                </div>` : ''}
            `);
        }

        // Update table status if it exists
        const rows = document.querySelectorAll('#vehicle-list .text-heading');
        rows.forEach(row => {
            if (row.innerText.trim() === vehicle_id) {
                const badge = row.nextElementSibling;
                if (badge) {
                    badge.innerText = status;
                    badge.className = `badge bg-${status === 'On Route' ? 'success' : 'secondary'} bg-opacity-10 text-${status === 'On Route' ? 'success' : 'secondary'} x-small`;
                }
            }
        });
    });

    function reoptimizeRoute(routeId) {
        showToast('Processing', 'Recalculating optimal path from current GPS coordinates...', 'warning');
        fetch('/optimization/api/reoptimize-route', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ route_id: routeId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Success', data.message, 'success');
                } else {
                    showToast('Error', data.error, 'danger');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('System Error', 'Failed to reach optimization server', 'danger');
            });
    }

    // Load vehicles on page load
    loadVehicles();

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', loadVehicles);

    // Auto-refresh fallback (longer interval since we have sockets)
    setInterval(loadVehicles, 30000);
</script>
{% endblock %}